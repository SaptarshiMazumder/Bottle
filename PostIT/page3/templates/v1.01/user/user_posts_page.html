{% extends 'v1.01/base/base.html' %}
{% load static %}
{% block title %}
Page3 - Community
{% endblock title %}

{% block content %}
{% include 'v1.01/navigation/navbar-top.html' %}
{% include 'community/community_header.html' %}

<div class="main-body">
   {% include 'v1.01/navigation/sidebar-left.html' %}


    <div class="page-contents user-profile-page-contents">

         <div class="profile-interact-section">
            <div class="interact-btn">
                Follow
            </div>
            <div class="interact-btn">
                Vouch
            </div>
            </div>
            <div class="logged_in_user" style="display: none">{{user.username}}</div>
            <div class="not_display_info">
            <h2 class="user_name" style="display: none">
                {{profile_owner.username}}
            </h2>
        </div>

        <div class="profile-stats">
            <div class="profile-stats-left">
                <div class="player-card-section" id="player-card-section"></div>
                {%for g in selected_user_gamer_profiles%} {% if g.game == selected_user_main_gamer_profile.main_gamer_profile.game %}
                <div class="profile-info-container">
                    <div class="dropdown-btn-section">
                        {% include 'v1.01/gamerProfile/gamer_profile_dropdown_btn.html' %}
                    </div>
            
                    <div class="user-profile-info ">
            
                        <div class="info-item">
                            <div class="value">103</div>
                            <div class="label">Followers</div>
                        </div>
                        <div class="info-item">
                            <div class="value">25</div>
                            <div class="label">Following</div>
                        </div>
                        <div class="info-item">
                            <div class="value">5</div>
                            <div class="label">Vouched</div>
                        </div>
                    </div>
            
                    <div id="additional-stats-desktop" class="additional-stats-desktop">
            
                    </div>
                </div>
                {%endif%}
                {%endfor%}
            
            
            </div>
           <div class="profile-stats-right">
                <div class="blocker-page-community" id="blocker-page-community"></div>
                <ul>
                    {% if objects.has_next %}
                    <a class="infinite-more-link" href="?page={{objects.next_page_number}}"></a>

                    {% endif %}


                    <div class="infinite-container profile-page-posts-container" id="myDIV">


                        {% for post in posts %}
                        {% if not post.is_reply %}
                        <div class="infinite-item post-item">
                            <div value="{{ post.id }}">
                                {% include 'v1.01/post/post_element/post_element_home_timeline.html' %}

                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                </ul>
                
            </div>

        </div>

        {% include 'navigation/sidebar.html' %}
    </div>
</div>

{% if user.is_authenticated %}
<div class="sidebar_right_blocker"></div>
<div class="sidebar-right-mobile">
    {% include 'navigation/sidebar-right-mobile.html' %}
</div>

{% endif %}

<nav id="main-bottom-nav">
    {% include 'navigation/navbar-bottom.html' %}
</nav>

<div class="body-bg"></div>

<script src="{% static 'PostIT/js/bottom_navbar.js'%}"></script>

<script src="{% static 'PostIT/js/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'PostIT/js/infinite.min.js'%}"></script>




<script>

    $(document).ready(function () {
        // $('.profile-info-posts').addClass('selected-tab');
    })

    $(document).on('click', '#like-button', function (e) {
        e.preventDefault();

        var this_ = $(this)
        postid = this_.attr("value").valueOf()

        // var somevar = this_.attr()
        $.ajax({
            type: 'POST',
            url: '{% url "like" %}',
            data: {
                postid: postid,
                // postid: $('#like-button').val(),
                action: 'post',
                // postid: '{{ post.pk }}',
            },
            success: function (json) {

                // this.getElementById("like-button").innerHTML = json['result']
                // document.getElementsByTagName('{{post.id}}').innerHTML = json['result']

                // document.getElementById("like_count").innerHTML = json['result'];
                // no_of_likes = this_.attr("name").valueOf();
                no_of_likes = json['result'];
                console.log(json)
                updateText(this_, no_of_likes)
            },
            error: function (xhr, errmsg, err) {

            }
        });
    })

    function playPauseVideo() {
        let videos = document.querySelectorAll("video");
        console.log("VIDEOS" + videos)
        videos.forEach((video) => {
            // We can only control playback without insteraction if video is mute
            video.muted = true;
            // Play is a promise so we need to check we have it
            let playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.then((_) => {
                    let observer = new IntersectionObserver(
                        (entries) => {
                            entries.forEach((entry) => {
                                if (
                                    entry.intersectionRatio !== 1 &&
                                    !video.paused
                                ) {
                                    video.pause();
                                } else if (video.paused) {
                                    video.play();
                                }
                            });
                        },
                        { threshold: 0.9 }
                    );
                    observer.observe(video);
                });
            }
        });
    }


</script>

<script>
    $(document).ready(function () {

        $('.follow_btn').click(function () {
            console.log('Follow btn clicked')
            $.ajax({
                type: 'POST',
                url: `/start_following/${$('.user_name').text()}`,
                data: {
                    'user': $('.logged_in_user').text(),
                    // csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function (response) {

                },
                error: function (response) {
                    //alert("Error getting ranks and servers")
                }
            })
        })
    })
</script>

<script>


    var infinite = new Waypoint.Infinite({
        element: $('.infinite-container')[0],
        offset: 'bottom-in-view',
        onBeforePageLoad: function () {
            console.log("Objects loaded before load" + '{{objects}}')
        },
        onAfterPageLoad: function () {
            console.log("Objects loaded after load" + '{{objects.has_previous}}')
        }

    })
    function updateText(btn, no_of_likes) {
        //btn.element.innerHTML = "LIKED BY" + " " + no_of_likes + "lkl"
        //btn.text("LIKED BY" + " " + no_of_likes + " <h1>JLO</h1>")
        elem = "<i class='fa-solid fa-heart'></i>"
        btn[0].innerHTML = no_of_likes + elem
        console.log(btn[0].innerHTML)
    }

    window.addEventListener("pageshow", myfunction(event))

    function myfunction(e) {
        let allLikes = document.getElementsByClassName('like-button');


        for (let i = 0; i < allLikes.length; i++) {
            let attributeValue = allLikes[i].getAttribute('value');


            $.ajax({
                type: 'POST',
                url: '{% url "set_likes" %}',
                data: {
                    postid: attributeValue,
                    // postid: $('#like-button').val(),
                    action: 'post',
                    // postid: '{{ post.pk }}',
                },
                success: function (json) {


                    // this.getElementById("like-button").innerHTML = json['result']
                    // document.getElementsByTagName('{{post.id}}').innerHTML = json['result']

                    // document.getElementById("like_count").innerHTML = json['result'];
                    // no_of_likes = this_.attr("name").valueOf();


                    no_of_likes = json['result'];
                    //console.log(json)
                    //updateText(allLikes[i], no_of_likes)
                    //allLikes[i].innerHTML = "LIKED BY" + " " + no_of_likes
                    //console.log("AJAX LIKES UPDATE REQUEST")

                    updateText(allLikes[i], no_of_likes)
                },
                error: function (response) {

                }
            });


        }
        console.log(allLikes)

    }


    function storeScroll() {

        scrollPos = window.pageYOffset
        localStorage.setItem("scrollPosition", scrollPos);
        localStorage.setItem("loadedPosts", '{{objects}}')
        console.log(localStorage.getItem("loadedPosts"))
        console.log(localStorage.getItem("scrollPosition"))
        console.log("Scroll position Y: " + scrollPos)
    }

    //window.addEventListener("pageshow", scrollToPos);

    function scrollToPos() {
        //e.preventDefault()
        //const element = document.getElementById("myDIV");
        //alert("Attempt Scroll" + element)
        //element.scrollLeft = 5000;
        //element.scrollTop = 3000;
        console.log(localStorage.getItem("scrollPosition"))
        //if ('scrollRestoration' in window.history) {
        //  console.log(window.history.scrollRestoration)
        window.history.scrollRestoration = 'manual'
        window.scrollTo(0, localStorage.getItem("scrollPosition"))
        //}
        setTimeout(function () { console.log("gjhkljhvjkl") })

        //alert("Attempt Scroll")
        //$("html, body").animate({ scrollTop: parseInt(localStorage.getItem("scrollPosition")) }, 2000);
        //setTimeout(function () { window.scrollTo(0, parseInt(localStorage.getItem("scrollPosition"))) }, 200)
        //setTimeout(function () { $("html, body").animate({ scrollTop: parseInt(localStorage.getItem("scrollPosition")) }, 2000); }, 200)
        //$("html, body").animate({ scrollTop: 5000 }, 2000);
        //window.scroll(0, parseInt(localStorage.getItem("scrollPosition")))
        //window.scrollTo(0, parseInt(localStorage.getItem("scrollPosition")));


    }


</script>

<script>
    var selected_gamer_profile;
    $(".games-dropdown-container").css("display", "none");

    $("#dropdown-btn").click(Toggle_Main_Dropdown_Display);
    selected_gamer_profile = $(".main_game").text();
    get_selected_game_stats();
    Toggle_Main_Dropdown_Display();
    Default_Bottom_Navabar_State();


    $(".games-dropdown-btn").click(function () {
        selected_gamer_profile = $(this).text().trim();
        console.log(selected_gamer_profile);
        get_selected_game_stats();
    });

    function get_selected_game_stats() {
        user_name = $(".user_name").text().replaceAll(" ", "");
        $.ajax({
            type: "POST",
            url: `/get_user_profile_stats/${user_name}/${selected_gamer_profile}`,

            dataType: "json",
            data: {
                game: selected_gamer_profile,
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function (response) {
                $("#player-card-section").html(response["gamer_profile_stats"]);
                $("#profile-stats-right").html(response["detailed_stats"]);
                $("#additional-stats-desktop").html(response["sidebar_additional_stats"]);
                $("#additional-stats-mobile").html(response["sidebar_additional_stats"]);
                console.log(response["game_logo"]);
                $(".gamer_profiles-btn_to_show_all_stats_text").text(
                    selected_gamer_profile
                );
                $(".gamer_profiles-btn_to_show_all_stats-img").attr(
                    "src",
                    response["game_logo"]
                );
                $(".games-dropdown-container").css("display", "none");
            },
        });
    }

    function Toggle_Main_Dropdown_Display() {
        if ($(".games-dropdown-container").css("display") == "flex") {
            $(".games-dropdown-container").css("display", "none");
        } else $(".games-dropdown-container").css("display", "flex");
    }


</script>


<script src="{% static 'PostIT/js/togglePostOptions.js'%}"></script>
<script src="{% static 'PostIT/js/toggleColorMode.js'%}"></script>
{% endblock content %}