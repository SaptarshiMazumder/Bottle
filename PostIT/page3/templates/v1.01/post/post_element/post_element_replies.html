{% load static %}
<div class="post">
    <div>
        {% include 'v1.01/post/post_element/post_content_section.html' %}

        <div class="post-bottom-section">
            <section class="post-user-info-section">
                <div class="profile-pic">
                    {%if post.author.profile.profile_pic.name %}
                    <a href="{%url 'user-profile-stats' post.author%}"><img src="{{ post.author.profile.profile_pic.url }}" width="500"></a>
                    {% endif %}
                    <!-- <img src="{{ post.user_profile.profile_pic.url }}" width="500"> -->
                </div>

                <span class="post-profile-section">
                        <div class="username">
                            <a href="{%url 'user-profile-stats' post.author%}">
                                {{post.author}}
                            </a>
                            {% if post.is_lft_lfp_post %}
                            <a href="{% url 'vouched-by' post.author.profile.id %}" class="vouch-info"><i class="fa-solid fa-award"></i>
                                {{post.author.profile.vouched_by.count}}
                            </a>
                            {% endif %}
                        </div>
                        <div class="date">
                            <small> {{post.post_date}}</small>
                        </div>
                    </span>

                <div id="three-dots" class="post-options-button three-dots" value="{{post.id}}">

                    <div class="post-options-list " id="post-options-list" value="{{post.id}}">

                        <div class="post-options-list-items">

                            <ul>
                                {% if user.is_authenticated %} {% if user.id == post.author.id %}

                                <li><a href="{% url 'delete-post' post.pk %}"><i class="fa-solid fa-trash"></i>Delete</a>
                                    <div class="content-after"></div>
                                </li>
                                <!-- <button id="like-button" value="{{ post.pk }}">Like</button> -->
                                {% endif %} {% endif %}
                                <li><i class="fa-solid fa-bookmark"></i>Add to Bookmarks
                                    <div class="content-after"></div>
                                </li>
                                <li><i class="fa-solid fa-share"></i>Share
                                    <div class="content-after"></div>
                                </li>
                                <li><i class="fa-solid fa-user-plus"></i>Follow @{{post.author}}
                                    <div class="content-after"></div>
                                </li>
                                <li><i class="fa-solid fa-ban"></i>Block @{{post.author}}
                                    <div class="content-after"></div>
                                </li>
                                <li><i class="fa-solid fa-volume-xmark"></i>Mute @{{post.author}}
                                    <div class="content-after"></div>
                                </li>
                                <li><i class="fa-solid fa-flag"></i>Report
                                    <div class="content-after"></div>
                                </li>
                            </ul>
                            <button id="post-options-list-close" class="post-options-list-close" value="{{post.id}}"><i class="fa-solid fa-xmark"></i></button>
                            <div class="blocker" id="blocker" value="{{post.id}}"></div>
                        </div>

                    </div>
                    <i class="fa-solid fa-ellipsis-vertical" id="three-dots" value="{{post.id}}"></i>
                </div>

            </section>
            {% if user.is_authenticated %}

        <div class="post-interact-btns">
            <div class="post-interact"></div>
            <button id="like-button" class="like-button" name="{{ post.like_count }}" value="{{ post.id }}">{{post.like_count}}<i class="fa-regular fa-heart"></i>
                </button>


            <a class="reply-button" href="{% url 'upload_reply' post.pk %}" onclick="storeScroll()">
                    {{post.reply_count}}<i class="fa-regular fa-comment"></i></a>


        </div>
        {% endif %}
        </div>

        {% if user.is_authenticated %}

        <!-- <span id="like_count" type="hidden">{{ post.like_count}}</span> -->

        <!-- Modal start -->

        <div class="reply-modal-container" id="reply-modal-container">
            <div class="modal-div">
                <h5>reply to</h5>
                {% include 'v1.01/post/post_replies_form.html' %}
                <button id="close-modal">CLose modal</button>
            </div>
        </div>

        <!-- Modal end -->
        <div class="post-interact"></div>
        <button id="like-button" class="like-button" name="{{ post.like_count }}"
            value="{{ post.id }}">{{post.like_count}}<i class="fa-solid fa-heart"></i>
        </button>

        <!-- 
        <a class="reply-button" href="{% url 'upload_reply' post.pk %}" onclick="storeScroll()">
            {{post.reply_count}}<i class="fa-solid fa-comment"></i></a> -->
        {%if post.user_profile %}
        <!-- {{post.user_profile}} -->
        <button id="open-reply-modal" class="reply-button" value="{{post.pk}}">{{post.reply_count}}<i
                class="fa-solid fa-comment"></i></button>
        {%endif %}
        {% endif %}

        {% if post.is_lft_lfp_post %}
        <!-- <button id="vouch-button" class="vouch-button" name="{{ post.vouch_count }}"
            value="{{ post.id }}">{{post.vouch_count}}Vouch
        </button> -->

        <!-- Vouch user starts -->
        {% if vouched_for_user %}
        <button class="vouch-user-button button-4" value="{{post.author.profile.user.id}}">Vouched <i
                class='fa-solid fa-check'></i></button>

        {% else %}
        <button class="vouch-user-button button-3" value="{{post.author.profile.user.id}}">Vouch </button>
        {% endif %}

        <!-- Vouch user ends -->
        {% endif %}
        <div class="post-stats">
            <div style="cursor: pointer;">
                <a href="{% url 'liked-by' post.id %}"> View Likes</a>
            </div>
            {% if post.is_lft_lfp_post %}
            <div>
                <a href="{% url 'vouched-by' post.author.profile.id %}">View Vouches</a>


            </div>
            {% endif %}
        </div>

    </div>
</div>

<script src="{% static 'PostIT/js/togglePostOptions.js'%}"></script>

<script>
    function updateVouchButtonText(btn, no_of_vouches, vouched_for_user) {
        if (vouched_for_user) {
            elem1 = "<i class='fa-solid fa-check'></i>"
            elem = "Vouched <i class='fa-solid fa-check'></i>"
            btn[0].className = "vouch-user-button button-4"
        }
        else {

            elem = "Vouch"
            btn[0].className = "vouch-user-button button-3"
        }
        vouch_count_text = document.getElementsByClassName("vouch-count")[0]
        console.log("Vouch ccount" + vouch_count_text)
        btn[0].innerHTML = elem

        vouch_count_text.innerHTML = no_of_vouches
        console.log(btn[0].innerHTML)
    }


    $(document).on('click', '.vouch-user-button', function (e) {
        e.preventDefault();

        var this_ = $(this)
        userid = this_.attr("value").valueOf()
        console.log("Trying to vouch")
        // var somevar = this_.attr()
        $.ajax({
            type: 'POST',
            url: '{% url "vouch-user" %}',
            data: {
                userid: userid,
                action: 'post',
            },
            success: function (json) {
                no_of_vouches = json['result'];
                vouched_for_user = json['vouched_for_user'];
                console.log(json)
                updateVouchButtonText(this_, no_of_vouches, vouched_for_user)
            },
            error: function (xhr, errmsg, err) {

            }
        });
    })
</script>